# Redirect www to apex
www.spectralcodex.com {
	redir https://spectralcodex.com{uri} permanent
}

# Main site, static files only
spectralcodex.com {
	root * /srv/www
	file_server
	encode gzip

	handle_errors {
		rewrite * /404.html
		file_server
	}

	# Enforce trailing slashes (except for files with extensions)
	@no_trailing_slash {
		path_regexp notrail ^(.+[^/])$
		not path_regexp \.[a-zA-Z0-9]+$
	}
	redir @no_trailing_slash {re.notrail.1}/ 301

	# Redirects
	import redirects.caddy

	# Cache static assets aggressively
	@immutable path /_x/*
	header @immutable Cache-Control "public, max-age=31536000, immutable"

	@static path *.css *.js *.jpg *.jpeg *.png *.gif *.webp *.avif *.woff2 *.woff
	header @static Cache-Control "public, max-age=31536000"

	# HTML pages - short cache
	@html path *.html /
	header @html Cache-Control "public, max-age=3600"
}

# Analytics
u.spectralcodex.com {
	reverse_proxy umami:3000
}

# Image server (through nginx cache)
img.spectralcodex.com {
	reverse_proxy ipx-cache:80
}

# API
api.spectralcodex.com {
	respond "API coming soon!" 503
}
