---
import type { HTMLAttributes } from 'astro/types';

import type { ImageLayout } from '#lib/image/image-layout.ts';

import { ImageLayoutEnum } from '#lib/image/image-layout.ts';
import { renderSlot } from '#lib/utils/astro.ts';

interface Props extends HTMLAttributes<'div'> {
	layout?: Extract<ImageLayout, 'medium' | 'wide'>;
	columns?: number | string;
}

const { layout, columns: columnsProp, ...props } = Astro.props;

// This conditional controls whether slot contents are just passed through
const { isFeed } = Astro.locals;

// This outputs MDX components already transformed into HTML
const slotContents = await renderSlot(Astro.slots, 'default');

const imageCount = slotContents?.match(new RegExp('<img', 'g'))?.length ?? 0;

if (imageCount === 0) {
	console.warn('[MDX] ImgGroup component has no images!');
}

function getGridColumnCount(itemCount: number) {
	if (itemCount % 5 === 0) return 5;
	if (itemCount % 4 === 0) return 4;
	if (itemCount % 3 === 0) return 3;
	if (itemCount % 2 === 0) return 2;
	return 1;
}

const columns = getGridColumnCount(columnsProp ? Number(columnsProp) : imageCount);
---

{imageCount > 0 && isFeed ? <Fragment set:html={slotContents} /> : undefined}
{
	imageCount > 0 && !isFeed ? (
		<div
			class:list={[
				'figure-group',
				'not-prose',
				'mb-2 sm:px-small md:mb-4 md:px-medium',
				layout === ImageLayoutEnum.Wide ? 'w-full' : 'mx-auto max-w-content',
				columns > 1 ? 'grid grid-cols-1 gap-2 md:gap-4' : undefined,
				columns === 2 ? 'sm:grid-cols-2' : undefined,
				columns === 3 ? 'md:grid-cols-3' : undefined,
				columns === 4 ? 'md:grid-cols-4' : undefined,
				columns === 5 ? 'md:grid-cols-5' : undefined,
			]}
			{...props}
		>
			<Fragment set:html={slotContents} />
		</div>
	) : undefined
}
