---
import type { HTMLAttributes } from 'astro/types';

import type { ImageComponentProps } from '#components/image/image-component.astro';

import Image from '#components/image/image-component.astro';
import ImagePlaceholder from '#components/image/image-placeholder.astro';
import CardFrame from '#components/parts/card-frame.astro';
import ProseDescription from '#components/parts/prose-description.astro';
import { TAILWIND_BREAKPOINT_SM } from '#constants.ts';
import { getImageByIdFunction } from '#lib/collections/images/utils.ts';
import { getImageSrcsetWidths, ImageSizeEnum } from '#lib/image/image-layout.ts';
import { renderSlot } from '#lib/utils/astro.ts';
import { sanitizeAltAttribute } from '#lib/utils/text.ts';

interface Props extends HTMLAttributes<'div'> {
	imageId?: string | undefined;
	linkUrl: string;
	alt: string;
}

const { imageId, linkUrl, alt, ...props } = Astro.props;

async function getImageProps() {
	const getImageById = await getImageByIdFunction();

	const imageEntry = getImageById(imageId);

	if (!imageId || !imageEntry)
		return { imageEntry: undefined, imageProps: undefined, placeholder: undefined };

	const aspectRatio = 3 / 2;

	return {
		imageProps: {
			src: imageId,
			breakpoints: getImageSrcsetWidths({
				maxWidth: imageEntry.data.width,
				widths: [
					ImageSizeEnum.ExtraSmall,
					ImageSizeEnum.Small,
					ImageSizeEnum.Medium,
					ImageSizeEnum.Large,
				],
			}),
			sizes: `(max-width: ${TAILWIND_BREAKPOINT_SM}) 100vw, 410px`,
			width: ImageSizeEnum.Medium,
			height: Math.round(ImageSizeEnum.Medium / aspectRatio),
			unstyled: true,
			alt: sanitizeAltAttribute(alt),
			operations: {
				fit: 'cover',
			},
		} satisfies ImageComponentProps,
		placeholder: imageEntry.data.placeholder,
	};
}

const { imageProps, placeholder } = await getImageProps();

const titleMultilingual = await renderSlot(Astro.slots, 'preview-title-multilingual');
const subtitle = await renderSlot(Astro.slots, 'preview-subtitle');
const description = await renderSlot(Astro.slots, 'preview-description');
---

<CardFrame {...props}>
	{
		imageProps ? (
			<ImagePlaceholder class="overflow-hidden rounded-xs shadow-sm" placeholder={placeholder}>
				<a href={linkUrl}>
					<Image class="aspect-3/2 w-full object-cover text-sm text-transparent" {...imageProps} />
				</a>
			</ImagePlaceholder>
		) : (
			<div class="aspect-3/2 w-full rounded-xs bg-fallback text-sm text-transparent shadow-inner" />
		)
	}
	<h2 class="mt-1 flex flex-wrap gap-x-1 text-xl">
		<a
			href={linkUrl}
			class:list={[
				'font-display font-bold transition-colors ease-in',
				'text-primary-700 hover:text-accent-500 dark:text-primary-300 dark:hover:text-accent-400',
			]}
		>
			<slot name="preview-title" />
		</a>
		{
			titleMultilingual ? (
				<div class:list={['inline-flex font-semibold', 'text-primary-500 dark:text-primary-400']}>
					<span class="font-light">(</span>
					<Fragment set:html={titleMultilingual} />
					<span class="font-light">)</span>
				</div>
			) : undefined
		}
	</h2>
	{
		subtitle ? (
			<div
				class:list={['mt-1 flex flex-wrap gap-1 text-sm', 'text-primary-500 dark:text-primary-400']}
			>
				<Fragment set:html={subtitle} />
			</div>
		) : undefined
	}
	{
		description ? (
			<ProseDescription class="mt-1" showCompact={true}>
				<Fragment set:html={description} />
			</ProseDescription>
		) : undefined
	}
</CardFrame>
