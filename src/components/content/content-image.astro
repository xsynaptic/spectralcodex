---
import type { HTMLAttributes } from 'astro/types';

import type { ImageComponentProps } from '#components/parts/image.astro';
import type { ImageLayout } from '#lib/image/image-layout.ts';

import ImageMetadata from '#components/image/image-metadata.astro';
import ImagePlaceholder from '#components/image/image-placeholder.astro';
import Image from '#components/parts/image.astro';
import { FEATURE_IMAGE_METADATA } from '#constants.ts';
import { getImageByIdFunction } from '#lib/collections/images/utils.ts';
import {
	getImageLayoutProps,
	getImageSrcsetWidths,
	ImageLayoutEnum,
	ImageSizeEnum,
} from '#lib/image/image-layout.ts';
import { renderSlot } from '#lib/utils/astro.ts';
import { sanitizeAltAttribute, sanitizeCaption } from '#lib/utils/text.ts';

interface Props extends HTMLAttributes<'figure'> {
	imageId: string;
	alt?: string;
	layout?: ImageLayout;
	showMetadata?: boolean;
}

const {
	imageId,
	alt: altProp,
	layout = ImageLayoutEnum.Default,
	showMetadata = false,
	...props
} = Astro.props;

// This controls how the component is rendered; feeds require a less complex output
const { isFeed } = Astro.locals;

const slotContents = await renderSlot(Astro.slots, 'default');

function getAspectRatio(width: number, height: number) {
	function greatestCommonDenominator(a: number, b: number): number {
		return b === 0 ? a : greatestCommonDenominator(b, a % b);
	}

	const aspectRatioDivisor = greatestCommonDenominator(width, height);

	return `${String(width / aspectRatioDivisor)} / ${String(height / aspectRatioDivisor)}`;
}

async function getImageProps() {
	const getImageById = await getImageByIdFunction();

	const imageEntry = getImageById(imageId);

	if (!imageEntry) return { imageEntry: undefined, imageProps: undefined, placeholder: undefined };

	const layoutProps = getImageLayoutProps({
		width: imageEntry.data.width,
		height: imageEntry.data.height,
		layout,
	});
	const feedWidth =
		imageEntry.data.height > imageEntry.data.width ? ImageSizeEnum.Medium : ImageSizeEnum.Large;
	const primaryWidth = isFeed ? feedWidth : layoutProps.width;

	return {
		imageEntry,
		imageProps: {
			src: imageId,
			breakpoints: getImageSrcsetWidths({ maxWidth: imageEntry.data.width }),
			sizes: layoutProps.sizes,
			width: primaryWidth,
			...(isFeed
				? { height: Math.round((primaryWidth * imageEntry.data.height) / imageEntry.data.width) }
				: {}),
			unstyled: true,
			alt: sanitizeAltAttribute(altProp ?? slotContents ?? ''),
		} satisfies ImageComponentProps,
		placeholder: imageEntry.data.placeholder,
		aspectRatio: getAspectRatio(imageEntry.data.width, imageEntry.data.height),
	};
}

const { imageEntry, imageProps, placeholder, aspectRatio } = await getImageProps();

const caption = slotContents ? sanitizeCaption(slotContents) : undefined;
---

{
	imageProps ? (
		isFeed ? (
			<figure {...props}>
				<Image {...imageProps} />
				{caption ? (
					<figcaption>
						<Fragment set:html={caption} />
					</figcaption>
				) : undefined}
			</figure>
		) : (
			<figure
				class:list={[
					'@container', // Used by image metadata
					'content-image', // Custom CSS styles defined in src/styles/content.css
					'not-prose',
					layout === ImageLayoutEnum.Default
						? 'mx-auto mb-2 max-w-content sm:px-small md:mb-4 md:px-medium'
						: undefined,
					layout === ImageLayoutEnum.Wide ? 'mb-2 w-full sm:px-small md:px-medium' : undefined,
					layout === ImageLayoutEnum.Full ? 'mb-2 w-full' : undefined,
				]}
				{...props}
			>
				<ImagePlaceholder
					class:list={[
						'relative',
						layout === ImageLayoutEnum.Full ? undefined : 'overflow-hidden sm:rounded-xs',
					]}
					placeholder={placeholder}
				>
					<Image
						class:list={['m-0 text-sm text-transparent']}
						{...(aspectRatio ? { style: { aspectRatio } } : {})}
						{...imageProps}
					/>
					{FEATURE_IMAGE_METADATA && showMetadata ? (
						<ImageMetadata entry={imageEntry} />
					) : undefined}
				</ImagePlaceholder>
				{caption ? (
					<figcaption
						class:list={[
							'content-image-caption',
							'px-small py-1 text-sm leading-relaxed italic',
							'text-primary-500 dark:text-primary-400',
							layout === ImageLayoutEnum.Full
								? 'mx-auto max-w-content px-small md:px-medium'
								: 'sm:px-0',
						]}
					>
						<Fragment set:html={caption} />
					</figcaption>
				) : undefined}
			</figure>
		)
	) : undefined
}
