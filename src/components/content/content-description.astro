---
import type { CollectionEntry } from 'astro:content';

import { render } from 'astro:content';

import type { RegionLanguage } from '#lib/collections/regions/types.ts';

import ContentSection from '#components/content/content-section.astro';
import FormatMarkdown from '#components/format/format-markdown.astro';
import ProseBody from '#components/parts/prose-body.astro';
import ProseDescription from '#components/parts/prose-description.astro';
import { getFirstRegionByReferenceFunction } from '#lib/collections/regions/utils.ts';
import { getHasContent } from '#lib/utils/collections.ts';

interface Props {
	entry: CollectionEntry<'locations' | 'regions' | 'series' | 'themes'>;
}

const { entry } = Astro.props;

const getFirstRegionByReference = await getFirstRegionByReferenceFunction();

let regionLanguage: RegionLanguage | undefined;

if (entry.collection === 'regions') {
	regionLanguage = entry.data.langCode;
} else if (entry.collection === 'locations') {
	regionLanguage = getFirstRegionByReference(entry.data.override?.regions ?? entry.data.regions)
		?.data.langCode;
} else {
	regionLanguage = getFirstRegionByReference(entry.data.regions)?.data.langCode;
}

const hasContent = getHasContent(entry);

const { Content } = await render(entry);
---

{
	hasContent ? (
		<ProseBody class="pb-medium" data-pagefind-weight="2">
			<Content />
		</ProseBody>
	) : (
		<ContentSection>
			<Fragment slot="section-description">
				<ProseDescription data-pagefind-weight="2">
					<FormatMarkdown langCode={regionLanguage}>{entry.data.description}</FormatMarkdown>
				</ProseDescription>
			</Fragment>
		</ContentSection>
	)
}
