---
import { OPEN_GRAPH_IMAGE_HEIGHT, OPEN_GRAPH_IMAGE_WIDTH } from '@spectralcodex/shared/constants';
import { SEO } from 'astro-seo';
import { WEBMENTION_DOMAIN } from 'astro:env/client';

import type { MetaProps } from '#components/types.ts';

import { OPEN_GRAPH_IMAGE_DENSITY, OPEN_GRAPH_TWITTER_USERNAME } from '#constants.ts';
import { getImageByIdFunction } from '#lib/collections/images/images-utils.ts';
import { getTranslations } from '#lib/i18n/i18n-translations.ts';
import { getOpenGraphImageUrl } from '#lib/image/image-server.ts';
import { getSiteUrl } from '#lib/utils/routing.ts';
import { getSeoImageFallback } from '#lib/utils/seo.ts';
import { sanitizeAltAttribute, sanitizeDescription } from '#lib/utils/text.ts';

type Props = MetaProps;

const {
	title: contentTitle,
	description: descriptionRaw,
	ogType,
	image,
	imageId,
	imageAlt,
	article,
	prefetchUrls,
	noIndex,
	noFollow,
} = Astro.props;

const t = getTranslations();

const siteTitle = t('site.title');
const siteDescription = t('site.description');

const description = sanitizeDescription(descriptionRaw) ?? siteDescription;

async function generateOpenGraphImageUrl({
	imageId,
	imageUrl,
	imageAlt,
}: {
	imageId?: string | undefined;
	imageUrl?: string | URL | undefined;
	imageAlt: string;
}) {
	const getImageById = await getImageByIdFunction();

	const imageEntry = imageId ? getImageById(imageId) : undefined;

	const imageLocalUrl = imageUrl ? new URL(imageUrl, Astro.site).href : undefined;

	// Generate OG image URL using IPX CDN (no local image processing)
	const openGraphImageUrl =
		imageLocalUrl ?? (imageEntry ? getOpenGraphImageUrl(imageEntry.id) : getSeoImageFallback());

	return {
		url: openGraphImageUrl,
		height: OPEN_GRAPH_IMAGE_HEIGHT * OPEN_GRAPH_IMAGE_DENSITY,
		width: OPEN_GRAPH_IMAGE_WIDTH * OPEN_GRAPH_IMAGE_DENSITY,
		type: 'image/jpeg',
		alt: sanitizeAltAttribute(imageAlt),
	};
}

const openGraphImage = await generateOpenGraphImageUrl({
	imageId,
	imageUrl: image?.url,
	imageAlt: image?.alt ?? imageAlt ?? description,
});
---

<SEO
	title={contentTitle ?? siteTitle}
	titleTemplate={!!contentTitle && contentTitle !== siteTitle ? `%s - ${siteTitle}` : '%s'}
	titleDefault={siteTitle}
	description={description}
	openGraph={{
		basic: {
			title: contentTitle ? `${contentTitle} - ${siteTitle}` : siteTitle,
			type: ogType ?? 'website',
			image: openGraphImage.url,
		},
		optional: {
			description,
		},
		image: openGraphImage,
		...(ogType === 'article' && article !== undefined ? { article } : {}),
	}}
	twitter={{
		card: 'summary_large_image',
		site: OPEN_GRAPH_TWITTER_USERNAME,
		title: contentTitle ?? siteTitle,
		description,
		...(openGraphImage.url
			? {
					image: openGraphImage.url,
					imageAlt: openGraphImage.alt,
				}
			: {}),
	}}
	extend={{
		...(prefetchUrls && prefetchUrls.length > 0
			? { link: prefetchUrls.map((prefetchUrl) => ({ rel: 'prefetch', href: prefetchUrl })) }
			: {}),
		meta: [{ name: 'generator', content: Astro.generator }],
	}}
	{...noIndex ? { noindex: noIndex } : {}}
	{...noFollow ? { nofollow: noFollow } : {}}
/>
<link
	rel="alternate"
	type="application/rss+xml"
	title={siteTitle}
	href={`${getSiteUrl()}rss.xml`}
/>
<link rel="sitemap" href={`${getSiteUrl()}sitemap-index.xml`} />
{
	WEBMENTION_DOMAIN ? (
		<link rel="webmention" href={`https://webmention.io/${WEBMENTION_DOMAIN}/webmention`} />
	) : undefined
}
