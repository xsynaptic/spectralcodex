---
import type { ImageFeaturedObjectWithCaptionMetadata } from '#lib/image/image-featured.ts';
import type { ImageComponentProps, ImagePlaceholderProps } from '#lib/image/image-types.ts';

import ImageCarouselCaption from '#components/image/image-carousel-caption.astro';
import ImagePlaceholder from '#components/image/image-placeholder.astro';
import Image from '#components/parts/image.astro';
import { getImageByIdFunction } from '#lib/collections/images/images-utils.ts';
import { getImageLayoutSizesProp, getImageBreakpoints } from '#lib/image/image-layout.ts';
import { ImageLayoutEnum, ImageSizeEnum } from '#lib/image/image-types.ts';
import { ImageFitOptionEnum } from '#lib/image/image-types.ts';
import { sanitizeAltAttribute } from '#lib/utils/text.ts';

type Props = ImageFeaturedObjectWithCaptionMetadata;

const { id: imageId, title: alt = '', captionMetadata } = Astro.props;

async function getImageProps(
	imageId: string | undefined,
	alt: string
): Promise<{
	imageProps: ImageComponentProps | undefined;
	placeholderProps: ImagePlaceholderProps | undefined;
}> {
	const getImageById = await getImageByIdFunction();

	const imageEntry = getImageById(imageId);

	if (!imageId || !imageEntry) return { imageProps: undefined, placeholderProps: undefined };

	const aspectRatio = 3 / 2;
	const fit = ImageFitOptionEnum.Cover;

	return {
		imageProps: {
			src: imageId,
			breakpoints: getImageBreakpoints({
				maxWidth: imageEntry.data.width,
				widths: [
					ImageSizeEnum.ExtraSmall,
					ImageSizeEnum.Small,
					ImageSizeEnum.Medium,
					ImageSizeEnum.Large,
					ImageSizeEnum.ExtraLarge,
				],
			}),
			sizes: getImageLayoutSizesProp(ImageLayoutEnum.Default),
			width: ImageSizeEnum.Large,
			height: Math.round(ImageSizeEnum.Large / aspectRatio),
			alt: sanitizeAltAttribute(alt),
			unstyled: true,
			operations: { fit },
		},
		placeholderProps: {
			imageId,
			aspectRatio,
			fit,
		},
	};
}

const { imageProps, placeholderProps } = await getImageProps(imageId, alt);
---

{
	imageProps ? (
		<ImagePlaceholder class="carousel-item relative" placeholderProps={placeholderProps}>
			<Image class:list={['m-0 aspect-3/2 text-sm text-transparent']} {...imageProps} />
			{captionMetadata ? (
				<ImageCarouselCaption captionMetadata={captionMetadata} isHero={false} withTitle={false} />
			) : undefined}
		</ImagePlaceholder>
	) : undefined
}
