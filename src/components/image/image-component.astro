---
import type { CoreImageAttributes, UnpicBaseImageProps } from '@unpic/core';
import type { HTMLAttributes } from 'astro/types';
import type { IPXOperations, IPXOptions } from 'unpic/providers/ipx';

import { Image } from '@unpic/astro/base';
import { IPX_SERVER_SECRET } from 'astro:env/server';
import { transform as ipxTransform } from 'unpic/providers/ipx';

import { IMAGE_FORMAT, IMAGE_QUALITY } from '#constants.ts';
import { generateSignedUrl } from '#lib/image/image-server-utils.ts';
import { ipxBaseUrl } from '#lib/image/image-server.ts';

// Signed transformer that wraps IPX with URL signing and default operations
const signedIpxTransformer = (
	src: string | URL,
	operations: IPXOperations,
	options?: IPXOptions
) => {
	return generateSignedUrl(
		ipxTransform(
			src,
			{ ...operations, q: IMAGE_QUALITY, f: IMAGE_FORMAT },
			{ ...options, baseURL: ipxBaseUrl }
		),
		IPX_SERVER_SECRET
	);
};

// Props interface: same as unpic base but without transformer
type Props = HTMLAttributes<'img'> &
	Omit<UnpicBaseImageProps<IPXOperations, IPXOptions, CoreImageAttributes>, 'transformer'>;

export type ImageComponentProps = Props;

const props = Astro.props;
---

<Image {...props} transformer={signedIpxTransformer} />
