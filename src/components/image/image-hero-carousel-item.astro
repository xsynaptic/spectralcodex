---
import type { ImageComponentProps } from '#components/parts/image.astro';
import type { ImageFeaturedObjectWithCaptionMetadata } from '#lib/image/image-featured.ts';

import ImageCarouselCaption from '#components/image/image-carousel-caption.astro';
import ImagePlaceholder from '#components/image/image-placeholder.astro';
import Image from '#components/parts/image.astro';
import { getImageByIdFunction } from '#lib/collections/images/images-utils.ts';
import { getImageSrcsetWidths, ImageSizeEnum } from '#lib/image/image-layout.ts';
import { getCroppedPlaceholder } from '#lib/image/image-placeholder-cache.ts';
import { sanitizeAltAttribute } from '#lib/utils/text.ts';

interface Props extends ImageFeaturedObjectWithCaptionMetadata {
	index: number;
	withTitle?: boolean | undefined;
}

const { index, id: imageId, title: alt = '', captionMetadata, withTitle = false } = Astro.props;

async function getImageProps(imageId: string | undefined, alt: string, isFirst: boolean) {
	const getImageById = await getImageByIdFunction();

	const imageEntry = getImageById(imageId);

	if (!imageId || !imageEntry) return { imageProps: undefined, placeholder: undefined };

	const aspectRatio = 3 / 2;
	const width = ImageSizeEnum.ExtraExtraLarge;
	const height = Math.round(ImageSizeEnum.ExtraExtraLarge / aspectRatio);

	return {
		imageProps: {
			src: imageId,
			breakpoints: getImageSrcsetWidths({ maxWidth: imageEntry.data.width }),
			sizes: '100vw',
			width,
			height,
			alt: sanitizeAltAttribute(alt),
			unstyled: true,
			operations: {
				fit: 'cover',
			},
			...(isFirst ? { priority: true } : {}),
		} satisfies ImageComponentProps,
		placeholder: await getCroppedPlaceholder({
			imageId,
			width,
			height,
			fit: 'cover',
			highQuality: isFirst,
		}),
	};
}

const { imageProps, placeholder } = await getImageProps(imageId, alt, index === 0);
---

{
	imageProps ? (
		<ImagePlaceholder class="carousel-item relative" placeholder={placeholder}>
			<Image
				class:list={[
					'z-10 max-h-screen min-h-[400px] w-full text-sm text-transparent xl:min-h-screen',
					'aspect-3/2 sm:aspect-5/4 md:aspect-3/2 lg:aspect-16/9 xl:aspect-auto',
				]}
				{...(index === 0 ? { 'data-pagefind-meta': 'image[src], image_alt[alt]' } : {})}
				{...imageProps}
			/>
			{captionMetadata ? (
				<ImageCarouselCaption
					captionMetadata={captionMetadata}
					isHero={true}
					withTitle={withTitle}
				/>
			) : undefined}
		</ImagePlaceholder>
	) : undefined
}
