---
import type { RemoteImageProps } from 'astro:assets';

import { Image } from 'astro:assets';

import ImageHeroFrame from '#components/image-hero/image-hero-frame.astro';
import ImagePlaceholder from '#components/image/image-placeholder.astro';
import { IMAGE_FORMAT, IMAGE_QUALITY } from '#constants.ts';
import { getImageByIdFunction } from '#lib/collections/images/utils.ts';
import { getImageSrcsetWidths } from '#lib/image/image-layout.ts';
import { getImagePlaceholderDataUrlHq } from '#lib/image/image-placeholder.ts';
import { sanitizeAltAttribute } from '#lib/utils/text.ts';

interface Props {
	hasHeroImage: boolean;
	imageId: string | undefined;
	alt: string;
	class?: string | undefined;
}

const { hasHeroImage, imageId, alt, class: className } = Astro.props;

async function getImageProps(imageId: string | undefined, alt: string) {
	const getImageById = await getImageByIdFunction();

	const imageEntry = getImageById(imageId);

	return {
		imageProps: imageEntry
			? ({
					src: imageEntry.data.src,
					alt: sanitizeAltAttribute(alt),
					width: imageEntry.data.width,
					height: imageEntry.data.height,
					widths: getImageSrcsetWidths({ maxWidth: imageEntry.data.width }),
					sizes: '100vw',
					format: IMAGE_FORMAT,
					quality: IMAGE_QUALITY,
					loading: 'eager',
					decoding: 'sync',
					fetchpriority: 'high',
				} satisfies RemoteImageProps)
			: undefined,
		placeholder: imageEntry ? await getImagePlaceholderDataUrlHq(imageEntry.data.src) : undefined,
	};
}

const { imageProps, placeholder } = hasHeroImage
	? await getImageProps(imageId, alt)
	: { imageProps: undefined, placeholder: undefined };
---

{
	hasHeroImage ? (
		<ImageHeroFrame class:list={['overflow-hidden', className]}>
			<ImagePlaceholder placeholder={placeholder}>
				{imageProps ? (
					<Image
						class:list={[
							'z-10 max-h-screen min-h-[400px] w-full object-cover object-center text-sm text-transparent xl:min-h-screen',
							'aspect-3/2 sm:aspect-5/4 md:aspect-3/2 lg:aspect-16/9 xl:aspect-auto',
						]}
						data-pagefind-meta="image[src], image_alt[alt]"
						{...imageProps}
					/>
				) : (
					<div
						class:list={[
							'max-h-screen min-h-[400px] w-full object-cover object-center text-sm text-transparent xl:min-h-screen',
							'aspect-3/2 sm:aspect-5/4 md:aspect-3/2 lg:aspect-16/9 xl:aspect-auto',
						]}
					/>
				)}
			</ImagePlaceholder>
			<slot />
		</ImageHeroFrame>
	) : (
		<slot />
	)
}
