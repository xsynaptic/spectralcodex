---
import type { CollectionEntry } from 'astro:content';

import { render } from 'astro:content';

import type { ContentMetadataItem } from '#lib/metadata/metadata-types.ts';

import ContentCollectionLink from '#components/content/content-collection-link.astro';
import ContentDate from '#components/content/content-date.astro';
import ContentHeader from '#components/content/content-header.astro';
import ContentSectionAuthor from '#components/content/content-section-author.astro';
import ContentSectionBacklinks from '#components/content/content-section-backlinks.astro';
import ContentSectionRegions from '#components/content/content-section-regions.astro';
import ContentSectionThemes from '#components/content/content-section-themes.astro';
import ImageHero from '#components/image/image-hero.astro';
import MainSite from '#components/main/main-site.astro';
import DividedItem from '#components/parts/divided-item.astro';
import ProseBody from '#components/parts/prose-body.astro';
import TextMultilingual from '#components/parts/text-multilingual.astro';
import { getMultilingualContent } from '#lib/i18n/i18n-utils.ts';
import { getImageFeaturedHeroId } from '#lib/image/image-featured.ts';
import { DatePresetEnum } from '#lib/utils/date.ts';
import { MicroformatClassNames } from '#lib/utils/microformats.ts';
import { getPagefindBodyProp } from '#lib/utils/pagefind.ts';
import { getSeoArticleProps, getSeoHideSearch, getSeoImageProps } from '#lib/utils/seo.ts';
import { stripDiacritics } from '#lib/utils/text.ts';

interface Props {
	entry: CollectionEntry<'ephemera'>;
	backlinks: Array<ContentMetadataItem> | undefined;
}

const { entry, backlinks } = Astro.props;

const titleMultilingual = getMultilingualContent({ data: entry.data, prop: 'title' })?.primary;

const regionIds = entry.data.regions?.map(({ id }) => id);
const themeIds = entry.data.themes?.map(({ id }) => id);

const imageHeroId = getImageFeaturedHeroId(entry.data.imageFeatured);

const hasHeroImage = !!imageHeroId;

const { Content } = await render(entry);

// TODO: convert `<!-- ${CONTENT_EXCERPT_IDENTIFIER} -->` to an anchor (#)
---

<MainSite
	meta={{
		title: titleMultilingual
			? `${entry.data.title} (${titleMultilingual.value})`
			: entry.data.title,
		description: entry.data.description ?? entry.body ?? undefined,
		image: await getSeoImageProps({
			id: entry.id,
			alt: entry.data.title,
		}),
		...getSeoArticleProps({
			dateCreated: entry.data.dateCreated,
			dateUpdated: entry.data.dateUpdated,
		}),
		...getSeoHideSearch(entry.data.hideSearch),
	}}
	hasHeroImage={hasHeroImage}
>
	<article class={MicroformatClassNames.Entry} {...getPagefindBodyProp(entry.data.hideSearch)}>
		<ImageHero
			class="sm:mb-small"
			hasHeroImage={hasHeroImage}
			imageId={imageHeroId}
			alt={entry.data.title}
		>
			<ContentHeader hasHeroImage={hasHeroImage}>
				<Fragment slot="header-title">
					<a href={Astro.url.toString()} class="p-name p-url" aria-hidden="true" tabindex="-1"
						>{stripDiacritics(entry.data.title)}</a
					>
				</Fragment>
				<Fragment slot="header-title-multilingual">
					<TextMultilingual content={titleMultilingual} />
				</Fragment>
				<Fragment slot="header-subtitle">
					<DividedItem hasHeroImage={hasHeroImage}>
						<ContentCollectionLink collection="ephemera" hasHeroImage={hasHeroImage} />
					</DividedItem>
					<DividedItem hasHeroImage={hasHeroImage}>
						<ContentDate
							date={entry.data.dateCreated}
							datePreset={DatePresetEnum.Medium}
							showMicroformats={true}
						/>
					</DividedItem>
					{
						entry.data.dateUpdated ? (
							<DividedItem hasHeroImage={hasHeroImage}>
								<ContentDate
									date={entry.data.dateUpdated}
									datePreset={DatePresetEnum.Medium}
									showMicroformats={true}
									showUpdated={true}
								/>
							</DividedItem>
						) : undefined
					}
				</Fragment>
			</ContentHeader>
		</ImageHero>
		<ProseBody class:list={['content', 'e-content', 'pb-small']} data-reading-frame>
			<Content />
		</ProseBody>
		<ContentSectionThemes themeIds={themeIds} />
		<ContentSectionRegions regionIds={regionIds} />
		<ContentSectionBacklinks backlinks={backlinks} />
		<ContentSectionAuthor showAuthor={false} />
	</article>
</MainSite>
