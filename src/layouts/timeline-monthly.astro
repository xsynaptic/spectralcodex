---
import { render } from 'astro:content';

import type { TimelineMonthlyItem } from '#lib/timeline/timeline-types.ts';

import ContentHeader from '#components/content/content-header.astro';
import ContentSection from '#components/content/content-section.astro';
import ImageHeroCarousel from '#components/image-hero/image-hero-carousel.astro';
import MainSite from '#components/main/main-site.astro';
import Link from '#components/parts/link.astro';
import ProseBody from '#components/parts/prose-body.astro';
import TimelineItem from '#components/timeline/timeline-item.astro';
import TimelineNavigation from '#components/timeline/timeline-navigation.astro';
import { getTranslations } from '#lib/i18n/i18n-translations.ts';
import {
	getImageFeaturedGroupByContentMetadata,
	getImageFeaturedObjectGroup,
} from '#lib/image/image-featured.ts';
import { getSiteUrl } from '#lib/utils/routing.ts';
import { getSeoHideSearch } from '#lib/utils/seo.ts';

interface Props {
	timelineMonthlyItem: TimelineMonthlyItem;
	timelineYears: Array<string>;
	timelineMonths?: Array<string> | undefined;
}

const { timelineMonthlyItem, timelineYears, timelineMonths } = Astro.props;

// Check for custom timeline entry
const { timelineEntry } = timelineMonthlyItem;

// Use custom imageFeatured from timeline entry if available, otherwise use generated highlights
const imageFeaturedGroup = timelineEntry?.data.imageFeatured
	? await getImageFeaturedObjectGroup({ imageFeatured: timelineEntry.data.imageFeatured })
	: getImageFeaturedGroupByContentMetadata({ items: timelineMonthlyItem.highlights });

const hasHeroImage = !!imageFeaturedGroup && imageFeaturedGroup.length > 0;

// Render timeline entry MDX content if available
const timelineRenderResult = timelineEntry ? await render(timelineEntry) : undefined;

const t = getTranslations();
---

<MainSite
	meta={{
		title: t('timeline.title'),
		description: t('timeline.monthly.description').replace('%s', timelineMonthlyItem.title),
		...getSeoHideSearch(true),
	}}
	hasHeroImage={hasHeroImage}
>
	<ImageHeroCarousel
		class="sm:mb-small"
		hasHeroImage={hasHeroImage}
		imageFeaturedGroup={imageFeaturedGroup}
	>
		<ContentHeader hasHeroImage={hasHeroImage}>
			<Fragment slot="header-title">{timelineMonthlyItem.title}</Fragment>
			<Fragment slot="header-subtitle">
				{
					hasHeroImage ? (
						<Link
							class="font-semibold"
							href={getSiteUrl('timeline')}
							linkColor="highlight-featured"
						>
							{t('timeline.title')}
						</Link>
					) : (
						<TimelineNavigation
							currentYear={timelineMonthlyItem.year}
							currentMonth={timelineMonthlyItem.month}
							timelineYears={timelineYears}
							timelineMonths={timelineMonths}
						/>
					)
				}
			</Fragment>
		</ContentHeader>
	</ImageHeroCarousel>
	<ContentSection marginSmall={true}>
		<TimelineNavigation
			class="border-b border-primary-300 pb-small dark:border-primary-700"
			currentYear={timelineMonthlyItem.year}
			currentMonth={timelineMonthlyItem.month}
			timelineYears={timelineYears}
			timelineMonths={timelineMonths}
		/>
	</ContentSection>
	{
		timelineRenderResult ? (
			<ProseBody class:list={['content', 'pb-small']}>
				<timelineRenderResult.Content />
			</ProseBody>
		) : undefined
	}
	<ContentSection class="flex flex-col gap-2">
		<TimelineItem
			title={t('timeline.monthly.updated')}
			items={timelineMonthlyItem.updated}
			count={timelineMonthlyItem.updatedCount}
		/>
		<TimelineItem
			title={t('timeline.monthly.created')}
			items={timelineMonthlyItem.created}
			count={timelineMonthlyItem.createdCount}
		/>
		<TimelineItem
			title={t('timeline.monthly.visited')}
			items={timelineMonthlyItem.visited}
			count={timelineMonthlyItem.visitedCount}
		/>
	</ContentSection>
</MainSite>
