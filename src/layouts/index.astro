---
import { transformMarkdown } from '@xsynaptic/unified-tools';

import type { ContentMetadataItem } from '#lib/types/index.ts';

import ContentSection from '#components/content/content-section.astro';
import ImageHeroCarousel from '#components/image-hero/image-hero-carousel.astro';
import MainSite from '#components/main/main-site.astro';
import IndexDescription from '#components/parts/index-description.astro';
import Link from '#components/parts/link.astro';
import PreviewGrid from '#components/preview/preview-grid.astro';
import { getTranslations } from '#lib/i18n/i18n-translations.ts';
import { getImageFeaturedGroupByContentMetadata } from '#lib/image/image-featured.ts';
import { getSiteUrl } from '#lib/utils/routing.ts';
import { getSeoImageProps } from '#lib/utils/seo.ts';

interface Props {
	featuredMetadataItems: Array<ContentMetadataItem>;
	recentMetadataItems: Array<ContentMetadataItem>;
	themesMetadataItems: Array<ContentMetadataItem>;
	seriesMetadataItems: Array<ContentMetadataItem>;
}

const { featuredMetadataItems, recentMetadataItems, themesMetadataItems, seriesMetadataItems } =
	Astro.props;

const imageFeaturedGroup = getImageFeaturedGroupByContentMetadata({
	items: featuredMetadataItems,
	shuffle: true,
});

// Use the content entry ID (not the image ID) for OG image lookup
const featuredOgImageId = imageFeaturedGroup?.at(0)?.captionMetadata?.id;

const hasHeroImage = !!imageFeaturedGroup && imageFeaturedGroup.length > 0;

const t = getTranslations();
---

<MainSite
	meta={{
		image: getSeoImageProps({
			...(featuredOgImageId ? { id: featuredOgImageId } : {}),
			alt: t('site.title'),
		}),
	}}
	hasHeroImage={hasHeroImage}
>
	{
		hasHeroImage ? (
			<ImageHeroCarousel
				hasHeroImage={hasHeroImage}
				imageFeaturedGroup={imageFeaturedGroup}
				withTitle={false}
			/>
		) : undefined
	}
	<IndexDescription />
	<ContentSection class="clear-both">
		<Fragment slot="section-title">{t('index.recent.label')}</Fragment>
		<PreviewGrid
			items={recentMetadataItems}
			showDate={true}
			showRegion={true}
			showTitleMultilingual={true}
		/>
	</ContentSection>
	<ContentSection>
		<Fragment slot="section-title"
			><Link href={getSiteUrl('themes')} linkColor="primary"
				>{t('collection.themes.labelPlural')}</Link
			></Fragment
		>
		<Fragment
			slot="section-description"
			set:html={transformMarkdown({ input: t('index.themes') })}
		/>
		<PreviewGrid
			items={themesMetadataItems}
			showLocations={true}
			showPosts={true}
			showTitleMultilingual={true}
		/>
	</ContentSection>
	<ContentSection>
		<Fragment slot="section-title"
			><Link href={getSiteUrl('series')} linkColor="primary"
				>{t('collection.series.labelPlural')}</Link
			></Fragment
		>
		<Fragment
			slot="section-description"
			set:html={transformMarkdown({ input: t('index.series') })}
		/>
		<PreviewGrid items={seriesMetadataItems} showLocations={true} showPosts={true} />
	</ContentSection>
</MainSite>
