---
import type { GetStaticPaths, InferGetStaticPropsType } from 'astro';

import * as R from 'remeda';

import { MAP_DIVISION_DATA_PATH } from '#constants.ts';
import RegionEntry from '#layouts/region-entry.astro';
import { getLocationsByIdsFunction } from '#lib/collections/locations/locations-utils.ts';
import { getPostsByIdsFunction } from '#lib/collections/posts/posts-utils.ts';
import { getRegionsCollection } from '#lib/collections/regions/regions-data.ts';
import { getRegionsOptions } from '#lib/collections/regions/regions-options.ts';
import { getRegionAncestorsFunction } from '#lib/collections/regions/regions-utils.ts';
import { LanguageCodeEnum } from '#lib/i18n/i18n-types.ts';
import { getMapData } from '#lib/map/map-data.ts';
import { getLocationsFeatureCollection } from '#lib/map/map-locations.ts';
import {
	filterHasFeaturedImage,
	getContentMetadataFunction,
	sortContentMetadataByDate,
} from '#lib/metadata/metadata-utils.ts';
import { getFilterEntryQualityFunction } from '#lib/utils/collections.ts';
import { getBaseUrl } from '#lib/utils/routing.ts';

export const getStaticPaths = (async ({ paginate }) => {
	const { entries } = await getRegionsCollection();

	const getRegionAncestors = await getRegionAncestorsFunction();
	const getPostsByIds = await getPostsByIdsFunction();
	const getLocationsByIds = await getLocationsByIdsFunction();
	const getContentMetadata = await getContentMetadataFunction();

	const results = [];

	for (const entry of entries) {
		const ancestors = getRegionAncestors(entry);

		// Note: this is temporary code to limit map display specified regions
		const displayRegionMapIds = new Set(['taiwan', 'hong-kong', 'thailand', 'vietnam', 'canada']);

		const showRegionMap =
			displayRegionMapIds.has(entry.id) ||
			ancestors.some((ancestor) => displayRegionMapIds.has(ancestor.id));

		const entryLocations = entry.data._locations ? getLocationsByIds(entry.data._locations) : [];

		const metadataItemsFiltered = R.pipe(
			[
				...R.pipe(entryLocations, R.filter(getFilterEntryQualityFunction(2)), getContentMetadata),
				...R.pipe(entry.data._posts ?? [], getPostsByIds, getContentMetadata),
			],
			R.filter(filterHasFeaturedImage),
			R.sort(sortContentMetadataByDate)
		);

		// Anything that wasn't included above
		const metadataItemsAll = R.pipe(
			entryLocations,
			R.filter(({ id }) => !metadataItemsFiltered.some((item) => item.id === id)),
			R.filter(({ data }) => !data.hideLocation),
			getContentMetadata,
			R.shuffle()
		);
		const metadataItems = metadataItemsAll.slice(0, 25);
		const metadataItemsCount = metadataItemsAll.length;

		const regionsOption = getRegionsOptions(getRegionAncestors(entry).length);

		const mapData = getMapData({
			mapId: `${entry.collection}/${entry.id}`,
			featureCollection: showRegionMap ? getLocationsFeatureCollection(entryLocations) : undefined,
			...(entry.data._langCode?.startsWith('zh')
				? { languages: [LanguageCodeEnum.English, LanguageCodeEnum.ChineseTraditional] }
				: {}),
			...(entry.data.divisionId && !entry.data.hideDivision
				? { apiDivisionUrl: getBaseUrl(MAP_DIVISION_DATA_PATH, `${entry.id}.fgb`) }
				: {}),
		});

		results.push(
			...paginate(metadataItemsFiltered, {
				params: { id: entry.id },
				props: {
					entry,
					mapData,
					metadataItems,
					metadataItemsCount,
					regionsOption,
				},
				pageSize: 20,
			})
		);
	}
	return results;
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;
---

<RegionEntry {...Astro.props} />
