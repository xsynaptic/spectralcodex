---
import type { GetStaticPaths, InferGetStaticPropsType } from 'astro';

import SeriesEntry from '#layouts/series-entry.astro';
import { getFirstRegionByReferenceFunction } from '#lib/collections/regions/regions-utils.ts';
import { getSeriesCollection } from '#lib/collections/series/series-data.ts';
import {
	getLocationsBySeriesFunction,
	getSeriesContentMetadataItemsFunction,
} from '#lib/collections/series/series-utils.ts';
import { LanguageCodeEnum } from '#lib/i18n/i18n-types.ts';
import { getMapData } from '#lib/map/map-data.ts';
import { getLocationsFeatureCollection } from '#lib/map/map-locations.ts';
import { getContentMetadataFunction } from '#lib/metadata/metadata-utils.ts';
import { getMapApiBaseUrl } from '#lib/utils/routing.ts';

export const getStaticPaths = (async ({ paginate }) => {
	const { series } = await getSeriesCollection();

	const getContentMetadata = await getContentMetadataFunction();
	const getSeriesContentMetadataItems = await getSeriesContentMetadataItemsFunction();
	const getSeriesLocations = await getLocationsBySeriesFunction();
	const getFirstRegionByReference = await getFirstRegionByReferenceFunction();

	const seriesItemsMetadata = getContentMetadata(series);

	const results = [];

	for (const entry of series) {
		const metadataItems = getSeriesContentMetadataItems(entry.data.seriesItems);

		if (!metadataItems) continue;

		const seriesLocations = getSeriesLocations(entry.data.seriesItems);

		const regionPrimary = getFirstRegionByReference(entry.data.regions);

		const mapData = getMapData({
			featureCollection: getLocationsFeatureCollection(seriesLocations),
			mapApiBaseUrl: getMapApiBaseUrl(entry.collection, entry.id),
			...(regionPrimary?.data.langCode?.startsWith('zh')
				? { languages: [LanguageCodeEnum.English, LanguageCodeEnum.ChineseTraditional] }
				: {}),
		});

		const wordCount = seriesItemsMetadata.find((item) => item.id === entry.id)?.wordCount;

		results.push(
			...paginate(metadataItems, {
				params: { id: entry.id },
				props: { entry, mapData, wordCount },
				pageSize: 20,
			}),
		);
	}
	return results;
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;
---

<SeriesEntry {...Astro.props} />
