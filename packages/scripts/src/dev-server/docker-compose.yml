# Local development IPX stack
# Managed by dev-server script
#
# Test endpoints:
#   Health: http://localhost:3100/health
#   Image:  http://localhost:3100/w_800,f_webp/path/to/image.jpg

services:
  # Nginx cache for IPX (ephemeral cache for dev)
  ipx-cache:
    image: nginx:1.27-alpine
    container_name: ipx-cache-dev
    ports:
      - "3100:80"
    volumes:
      - ./deploy/ipx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # Ephemeral cache - gone when container stops
      - type: tmpfs
        target: /var/cache/nginx/ipx
        tmpfs:
          size: 1073741824  # 1GB
    depends_on:
      ipx:
        condition: service_healthy
    networks:
      - ipx-dev

  # IPX image server
  ipx:
    build: ./deploy/ipx
    container_name: ipx-dev
    volumes:
      - ./${CONTENT_MEDIA_PATH:?CONTENT_MEDIA_PATH is required}:/media:ro
    environment:
      - NODE_ENV=development
      - PORT=3000
      - IPX_FS_DIR=/media
      - IPX_FS_MAX_AGE=86400
    networks:
      - ipx-dev
    mem_limit: 512m

networks:
  ipx-dev:
    driver: bridge
